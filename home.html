<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Cache-control" content="public" />
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Navigation</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
  <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
  <script src="https://raw.githack.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.min.js"></script>
  <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
  <script>
    THREEx.ArToolkitContext.baseURL =
      "https://raw.githack.com/jeromeetienne/ar.js/master/three.js/";
  </script>
  <link rel="stylesheet" href="./index.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />
  <link rel="icon" href="favicon.png" type="image/gif" sizes="16x16" />
</head>

<body style="margin: 0; overflow: hidden; ">
  <a-scene cursor="rayOrigin: mouse; fuse: true; fuseTimeout: 0;" raycaster="objects: [gps-entity-place];"
    vr-mode-ui="enabled: false" embedded
    arjs="sourceType: webcam; sourceWidth:1280; sourceHeight:960; displayWidth: 1280; displayHeight: 960; debugUIEnabled: false;">
    <!--will be "gps-new-camera" in update version   -->
    <a-camera gps-camera='minDistance: 5' rotation-reader> </a-camera>
  </a-scene>
  <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#routes" style="    position: fixed;
    bottom: 0;
    width: 100vw;
  left: 50%;
  right: 50%;
  margin-left: -50vw;
  margin-right: -50vw;
">
    Where do you want to go
  </button>

  <div id="routes" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="LargeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="myLargeModalLabel">Routes</h4>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">Ã—</span>
          </button>
        </div>
        <div class="modal-body" style="padding:0"></div>
      </div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script>
  <script src="./ar.js"></script>
  <script>


    // coords = current position coordinates , end = destination coords

    const loadPlaces = function (coords, end) {
      // console.log(end);
      return loadPlaceFromAPIs(coords, end);
    };

    // getting places from REST APIs
    // returns a set of coords from current location to destination 

    function loadPlaceFromAPIs(position, end) {

      var endpoint = `https://api.openrouteservice.org/v2/directions/foot-walking?api_key=5b3ce3597851110001cf6248449df15745a3444cae6960e8202aa401&start=${position.longitude},${position.latitude}&end=${end.long},${end.lat}`;
      
      return fetch(endpoint)
        .then(res => {
          return res.json().then(resp => {
            // console.log(resp);
            var data = [];
            data = data.concat(resp.features["0"].geometry.coordinates);
            // console.log(data);
            return data;
          });
        })
        .catch(err => {
          console.error("Error with places API", err);
        });
    }
  </script>
  <script>
    // var navbutton = [
    //   {
    //     name: "KR",
    //     lat: 23.365088,
    //     long: 85.253257
    //   }
    // ];

    var navbutton = [
    {
        name: "Vishwakarma Hostel",
        lat: 25.25820461084174,
        long: 82.9854877601788
      },
      {
        name: "Visvesvaraya Hostel",
        lat: 25.262316347890625,
        long: 82.98392949059952
      },
      {
        name: "Aryabhatta Hostel",
        lat: 25.26312729918257,
        long: 82.98434373855787
      },
      {
        name: "limdi Hostel",
        lat: 25.261237348221055, 
        long: 82.98603301779742
      },
      {
        name: "SC Dey",
        lat: 25.260237,
        long: 82.987016
      },
      {
        name: "Rajputana Hostel",
        lat: 25.262395339610556,
        long: 82.98619987354289      
      },
      {
        name: "Morvi Hostel",
        lat: 25.26512256113173,
        long: 82.98617826800256
      },
      {
        name: "Vivekanand Hostel",
        lat:25.259118863366204, 
        long :82.98683243341645
      },
      {
        name: "Swatantrata Bhavan",
        lat: 25.260763492542782, 
        long: 82.99451626861293
      },
      {
        name: "ADV Grounds",
        lat: 25.258835732276257,
        long: 82.99016853637981
      },
      {
        name: "LC",
        lat: 25.2607517936517, 
        long: 82.98686216132405
      },
      {
        name: "CCD",
        lat: 25.258057,
        long: 82.98686
      },
      {
        name: "G1-G11",
        lat: 25.262131,
        long: 82.992954
      },
      {
        name: "LT3",
        lat: 25.258943324357904, 
        long: 82.99266953995874
      },
      {
        name: "LT1",
        lat: 25.260201341902896, 
        long: 82.99082174641863
      },
      {
        name: "LT2",
        lat: 25.262022414018514,
        long:  82.99383398211168
      },
      {
        name: "Technex Office",
        lat: 25.261405844788392, 
        long: 82.98637023632241
      },
      {
        name: "Hyderabad Gate",
        lat: 25.262909,
        long: 82.982231
      },
      
      {
        name: "ABLT",
        lat: 25.262818447534354, 
        long: 82.9886537882128
      },
      {
        name: "Vishwanath Temple",
        lat: 25.26552195222019, 
        long: 82.98956452477454
      },
      {
        name: "Library",
        lat: 25.261888076516556,
        long:  82.98948187170173
      },
      {
        name: "Girls Hostel",
        lat: 25.261037,
        long: 82.98345
      },
      {
        name: "CSE Department",
        lat: 25.262496017667072, 
        long: 82.9934343893327
      },
      {
        name: "MnC Department",
        lat: 25.261835096902452,
        long: 82.99344663444077
      },
      {
        name: "Electronics Department",
        lat: 25.262741391183194,
        long: 82.99051471666101
      },
      {
        name: "Mechanical Department",
        lat: 25.26171659132048,
        long:  82.99183027943002
      },
      {
        name: "Civil Department",
        lat:25.262773183998018, 
        long:82.99195793661623
      },
      {
        name: "Chemical Department",  
        lat: 25.259778635068624,
        long:  82.98500236176552
      },
      {
        name: "ceramic Department",  
        lat: 25.259767335767393,
        long:  82.99280648219823
      },
      {
        name: "Pharma Department",  
        lat: 25.25922947871975,
        long:  82.9932080938016
      },
      {
        name: "Physics Department",  
        lat: 25.259569712316626,
        long:  82.9929631607754
      },
      {
        name: "School of material sciences",  
        lat: 25.25961604192507, 
        long: 82.99151277307918
      },
      {
        name: "Department of chemistry",  
        lat: 25.261272821246216, 
        long: 82.99174672641149 
      },
      {
        name: "Apollo Pharmacy",  
        lat: 25.260306331110392, 
        long: 82.98455213560122
      },
      {
        name: "Electrical Department",
        lat: 25.26177336837718, 
        long: 82.99237096620935
      }
    ];


    $(window).on("load", () => {


      // render the model  

      navbutton.forEach(button => {
        $(".modal-body").append(`<button
                lat="${button.lat}"
                long="${button.long}"
                type="button"
                class="list-group-item list-group-item-action"
              >
                ${button.name}
              </button>`);
      });


      // will be called when destination is selected 
      // ... fetch al coordinates from current coords to desti coords 
      // .. display markers at all those locations 

      function drawpath(end) {

        const scene = document.querySelector("a-scene");
        
        // get the current location coords 
        return navigator.geolocation.getCurrentPosition(

          function (position) {

            loadPlaces(position.coords, end).then(places => {
              places.forEach(place => {
               
                const latitude = place[1];
                const longitude = place[0];
                const icon = document.createElement("a-image");
                icon.setAttribute(
                  "gps-entity-place",                                 // will be gps-new-entity-place in latest versoion 
                  `latitude: ${latitude + + 0.001};
                   longitude: ${longitude};`
                );
                // icon.setAttribute("name", place.properties.name);
                icon.setAttribute("src", "./map-marker.png");
                icon.setAttribute("look-at", "[gps-camera]");
                icon.setAttribute("scale", "5,5,5");
                // console.log(icon);
                icon.addEventListener('loaded', () => {
                        window.dispatchEvent(new CustomEvent('gps-entity-place-loaded'))
               });
                scene.appendChild(icon);
              });
            });
          },
          err => alert("Error in retrieving position"), // console.error(, err),
          {
            enableHighAccuracy: true,
            maximumAge: 0,
            timeout: 27000
          }
        );

      }
      
      // define the click event 

      $(".modal-body button").click(e => {
        $("#routes").modal("hide");
        $("a-image").remove();
          // console.log($(e.target).attr("lat"));

        // end => coordinates of the selected destination  

        var end = {
          lat: $(e.target).attr("lat"),
          long: $(e.target).attr("long")
        };
        console.log(end);
        drawpath(end);
      });


    });
  </script>
</body>

</html>